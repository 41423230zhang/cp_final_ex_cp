{% extends "base.html" %}

{% block title %}Brython éŠæˆ²{% endblock %}

{% block content %}
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.3/brython.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.3/brython_stdlib.js"></script>
    
    <body onload="brython(1)"> 

    <h2 style="text-align: center;">ğŸ•¹ï¸ é»æ“Šæ¸¬è©¦ï¼šé»æ“Šç§»å‹•ä¸­çš„åœ“å½¢ï¼</h2>

    <div id="brython_div1" style="width: 600px; height: 400px; margin: 20px auto;">
    </div>

    {# ä½¿ç”¨ {% raw %} å¡Šï¼Œç¢ºä¿ Jinja2 ä¸æœƒè§£æ Brython ç¨‹å¼ç¢¼ä¸­çš„å¤§æ‹¬è™Ÿå’Œ f-string #}
    {% raw %} 
    <script type="text/python">
        from browser import document, timer, window, ajax
        import random
        import time

        # --- éŠæˆ²è¨­å®š ---
        GAME_DURATION = 30 
        score = 0
        game_active = False
        combo = 0
        miss_count = 0
        is_gold = False  # æ˜¯å¦æ˜¯é‡‘å¹£ç›®æ¨™

        # --- ç²å– DOM å…ƒç´ åŠåˆå§‹åŒ– ---
        game_area = document["brython_div1"]
        game_area.style.border = "3px solid #333"
        game_area.style.backgroundColor = "#e0e0ff"
        game_area.style.position = "relative"
        game_area.style.overflow = "hidden"
        game_area.style.cursor = "crosshair"

        # å‰µå»ºåˆ†æ•¸å’Œæ™‚é–“é¡¯ç¤ºå€
        score_display = document.createElement("div")
        score_display.style.position = "absolute"
        score_display.style.top = "10px"
        score_display.style.left = "10px"
        score_display.style.fontSize = "1.2em"
        score_display.style.fontWeight = "bold"
        score_display.style.backgroundColor = "rgba(255, 255, 255, 0.7)"
        score_display.style.padding = "5px"
        game_area <= score_display

        timer_display = document.createElement("div")
        timer_display.style.position = "absolute"
        timer_display.style.top = "10px"
        timer_display.style.right = "10px"
        timer_display.style.fontSize = "1.2em"
        timer_display.style.fontWeight = "bold"
        timer_display.style.backgroundColor = "rgba(255, 255, 255, 0.7)"
        timer_display.style.padding = "5px"
        game_area <= timer_display

        # å‰µå»ºç›®æ¨™å…ƒç´ 
        target = document.createElement("div")
        target.id = "target"
        target.style.width = "50px"
        target.style.height = "50px"
        target.style.backgroundColor = "#ff4500"
        target.style.position = "absolute"
        target.style.borderRadius = "50%"
        target.style.cursor = "pointer"
        target.style.transition = "background-color 0.1s, top 0.3s, left 0.3s"
        game_area <= target

        # å‰µå»ºéŠæˆ²çµæŸè¨Šæ¯
        game_over_msg = document.createElement("div")
        game_over_msg.style.position = "absolute"
        game_over_msg.style.top = "50%"
        game_over_msg.style.left = "50%"
        game_over_msg.style.transform = "translate(-50%, -50%)"
        game_over_msg.style.backgroundColor = "rgba(0, 0, 0, 0.9)"
        game_over_msg.style.color = "white"
        game_over_msg.style.padding = "30px"
        game_over_msg.style.borderRadius = "10px"
        game_over_msg.style.fontSize = "2em"
        game_over_msg.style.zIndex = "100"
        game_over_msg.style.display = "none"
        game_over_msg.style.textAlign = "center"
        game_area <= game_over_msg

        # --- éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---

        def move_target():
         global is_gold
            """ç§»å‹•ç›®æ¨™å…ƒç´ """
            if not game_active:
                return
            
            max_x = game_area.clientWidth - 50
            max_y = game_area.clientHeight - 50
            min_y = 40 

            new_x = random.randint(0, max(0, max_x))
            new_y = random.randint(min_y, max(min_y, max_y))
         # 20% æ©Ÿç‡é‡‘å¹£ç›®æ¨™
    if random.random() < 0.2:#41423224
        is_gold = True
        target.style.backgroundColor = "#ff0000"  # é‡‘é»ƒè‰²
    else:
        is_gold = False
        target.style.backgroundColor = f"rgb({random.randint(0,255)},{random.randint(0,255)},{random.randint(0,255)})"
            
            target.style.backgroundColor = f"rgb({random.randint(0, 255)}, {random.randint(0, 255)}, {random.randint(0, 255)})"
            
            target.style.left = f"{new_x}px"
            target.style.top = f"{new_y}px"

         if is_gold:
        score += 3
    else:
        score += 1

    combo += 1
    miss_count = 0

    score_display.text = f"åˆ†æ•¸: {score}ï¼ˆé€£æ“Š {combo}ï¼‰"

    # é€£æ“Š â†’ ç›®æ¨™è®Šå°
    current_size = int(target.style.width.replace("px", ""))
    new_size = current_size - 5
    new_size = max(20, new_size)
    target.style.width = f"{new_size}px"
    target.style.height = f"{new_size}px"

    move_target()
    event.stopPropagation()

@game_area.bind("click")
def miss_click(event):
    global miss_count, combo
    if not game_active:
        return

    miss_count += 1
    combo = 0

    # miss â†’ ç›®æ¨™è®Šå¤§
    current_size = int(target.style.width.replace("px", ""))
    new_size = current_size + 5
    new_size = min(150, new_size)
    target.style.width = f"{new_size}px"
    target.style.height = f"{new_size}px"

        def hit_target(event):
    global score, combo, last_hit_time
    if not game_active:
        return

    now = time.time()

    # Combo åˆ¤æ–·
    if now - last_hit_time < 0.8:
        combo += 1
    else:
        combo = 1
    last_hit_time = now

    # åŠ åˆ†
    score += combo
    score_display.text = f"åˆ†æ•¸: {score} (Combo x{combo})"

    #æ»‘é¼ 
    # æ–°å¢æ»‘é¼ è»Œè·¡æ•ˆæœ
TRAIL_SIZE = 10
TRAIL_LIFETIME = 300  # è»Œè·¡æŒçºŒæ™‚é–“

@game_area.bind("mousemove")
def mouse_trail(event):
    if not game_active:
        return

    dot = document.createElement("div")

    dot.style.width = f"{TRAIL_SIZE}px"
    dot.style.height = f"{TRAIL_SIZE}px"
    dot.style.borderRadius = "50%"
    dot.style.position = "absolute"

    #æ­£ç¢ºè¨ˆç®—æ»‘é¼ åœ¨ game_area å…§çš„ä½ç½®
    rect = game_area.getBoundingClientRect()
    x = event.clientX - rect.left
    y = event.clientY - rect.top

    dot.style.left = f"{x - TRAIL_SIZE//2}px"
    dot.style.top = f"{y - TRAIL_SIZE//2}px"

    alpha = min(0.2 + combo * 0.05, 0.8)
    dot.style.backgroundColor = f"rgba(255, 200, 0, {alpha})"

    dot.style.pointerEvents = "none"
    dot.style.transition = "opacity 0.3s"

    game_area <= dot

    def fade():
        dot.style.opacity = "0"
    timer.set_timeout(fade, 50)

    def remove():
        dot.remove()
    timer.set_timeout(remove, TRAIL_LIFETIME)


    #æ»‘é¼ 


        
           def hit_target(event):
    global score
    if not game_active:
        return

    score += 1
    score_display.text = f"åˆ†æ•¸: {score}"

    # çƒæ¶ˆå¤±
    target.style.opacity = "0"

    # 0.3 ç§’å¾Œç§»å‹•ä¸¦æ·¡å…¥
    def respawn():
        move_target()
        target.style.opacity = "1"

    timer.set_timeout(respawn, 300)

    event.stopPropagation()

        def restart_game(event):
            # ... (é‡æ–°é–‹å§‹é‚è¼¯ä¸è®Š)
            game_over_msg.style.display = "none"
            start_game()
            event.stopPropagation()

        def check_time():
            # ... (æª¢æŸ¥æ™‚é–“é‚è¼¯ä¸è®Š)
            global game_active
            
            game_over_time_diff = game_over_time - time.time()
            remaining = int(game_over_time_diff)
            
            if remaining <= 0:
                timer_display.text = "æ™‚é–“: 0s"
                if game_active:
                    game_active = False
                    
                    # éŠæˆ²çµæŸå¾Œæäº¤åˆ†æ•¸
                    submit_score_to_server(score) 
                    
                    # é¡¯ç¤ºçµæŸè¨Šæ¯
                    game_over_msg.innerHTML = f"éŠæˆ²çµæŸï¼<br>æœ€çµ‚åˆ†æ•¸: {score}"
                    
                    restart_btn = document.createElement("button")
                    restart_btn.text = "é‡æ–°é–‹å§‹"
                    restart_btn.style.marginTop = "15px"
                    restart_btn.style.padding = "10px 20px"
                    restart_btn.style.fontSize = "0.7em"
                    restart_btn.style.cursor = "pointer"
                    restart_btn.bind("click", restart_game)
                    
                    game_over_msg <= document.createElement("br")
                    game_over_msg <= restart_btn
                    game_over_msg.style.display = "block"
                    
                    timer.clear_interval(move_interval_handle)
                    
            else:
                timer_display.text = f"æ™‚é–“: {remaining}s"
                timer.set_timeout(check_time, 1000)

        # --- éŠæˆ²å•Ÿå‹•å‡½æ•¸ ---
        def start_game():
            # ... (å•Ÿå‹•é‚è¼¯ä¸è®Š)
            global game_active, game_over_time, move_interval_handle, score
            
            score = 0
            game_active = True
            score_display.text = "åˆ†æ•¸: 0"
            timer_display.text = f"æ™‚é–“: {GAME_DURATION}s"
            
            game_over_time = time.time() + GAME_DURATION
            
            check_time()
            move_target()
            move_interval_handle = timer.set_interval(move_target, 800) 
            
        # å•Ÿå‹•éŠæˆ²
        start_game()

    </script>
    {% endraw %}
    
    </body>
{% endblock %}
